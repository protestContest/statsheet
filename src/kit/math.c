#include "kit/math.h"

// sine table: SIN(0..88.6 degrees) * 0x8000, entries 0..255
// use symmetry for full circle: sin(90+x) = cos(x), sin(180+x) = -sin(x), etc.
static const u16 sinTable[256] = {
  0x0000, 0x00C9, 0x0192, 0x025B, 0x0324, 0x03ED, 0x04B6, 0x057E,
  0x0647, 0x0710, 0x07D9, 0x08A1, 0x096A, 0x0A32, 0x0AFB, 0x0BC3,
  0x0C8B, 0x0D53, 0x0E1B, 0x0EE3, 0x0FAB, 0x1072, 0x1139, 0x1200,
  0x12C7, 0x138E, 0x1455, 0x151B, 0x15E1, 0x16A7, 0x176D, 0x1833,
  0x18F8, 0x19BD, 0x1A82, 0x1B46, 0x1C0B, 0x1CCF, 0x1D93, 0x1E56,
  0x1F19, 0x1FDC, 0x209F, 0x2161, 0x2223, 0x22E4, 0x23A6, 0x2467,
  0x2527, 0x25E7, 0x26A7, 0x2767, 0x2826, 0x28E5, 0x29A3, 0x2A61,
  0x2B1E, 0x2BDB, 0x2C98, 0x2D54, 0x2E10, 0x2ECC, 0x2F86, 0x3041,
  0x30FB, 0x31B4, 0x326D, 0x3326, 0x33DE, 0x3496, 0x354D, 0x3604,
  0x36BA, 0x376F, 0x3824, 0x38D8, 0x398C, 0x3A40, 0x3AF2, 0x3BA5,
  0x3C56, 0x3D07, 0x3DB7, 0x3E67, 0x3F16, 0x3FC5, 0x4073, 0x4120,
  0x41CD, 0x4279, 0x4325, 0x43D0, 0x447A, 0x4524, 0x45CD, 0x4675,
  0x471C, 0x47C3, 0x4869, 0x490F, 0x49B3, 0x4A58, 0x4AFB, 0x4B9D,
  0x4C3F, 0x4CE0, 0x4D81, 0x4E20, 0x4EBF, 0x4F5D, 0x4FFB, 0x5097,
  0x5133, 0x51CE, 0x5268, 0x5302, 0x539B, 0x5432, 0x54C9, 0x5560,
  0x55F5, 0x568A, 0x571D, 0x57B0, 0x5842, 0x58D3, 0x5964, 0x59F3,
  0x5A82, 0x5B0F, 0x5B9C, 0x5C28, 0x5CB3, 0x5D3E, 0x5DC7, 0x5E4F,
  0x5ED7, 0x5F5D, 0x5FE3, 0x6068, 0x60EB, 0x616E, 0x61F0, 0x6271,
  0x62F1, 0x6370, 0x63EE, 0x646C, 0x64E8, 0x6563, 0x65DD, 0x6656,
  0x66CF, 0x6746, 0x67BC, 0x6832, 0x68A6, 0x6919, 0x698B, 0x69FD,
  0x6A6D, 0x6ADC, 0x6B4A, 0x6BB7, 0x6C23, 0x6C8E, 0x6CF8, 0x6D61,
  0x6DC9, 0x6E30, 0x6E96, 0x6EFB, 0x6F5E, 0x6FC1, 0x7022, 0x7083,
  0x70E2, 0x7140, 0x719D, 0x71F9, 0x7254, 0x72AE, 0x7307, 0x735E,
  0x73B5, 0x740A, 0x745F, 0x74B2, 0x7504, 0x7555, 0x75A5, 0x75F3,
  0x7641, 0x768D, 0x76D8, 0x7722, 0x776B, 0x77B3, 0x77FA, 0x783F,
  0x7884, 0x78C7, 0x7909, 0x794A, 0x7989, 0x79C8, 0x7A05, 0x7A41,
  0x7A7C, 0x7AB6, 0x7AEE, 0x7B26, 0x7B5C, 0x7B91, 0x7BC5, 0x7BF8,
  0x7C29, 0x7C59, 0x7C88, 0x7CB6, 0x7CE3, 0x7D0E, 0x7D39, 0x7D62,
  0x7D89, 0x7DB0, 0x7DD5, 0x7DFA, 0x7E1D, 0x7E3E, 0x7E5F, 0x7E7E,
  0x7E9C, 0x7EB9, 0x7ED5, 0x7EEF, 0x7F09, 0x7F21, 0x7F37, 0x7F4D,
  0x7F61, 0x7F74, 0x7F86, 0x7F97, 0x7FA6, 0x7FB4, 0x7FC1, 0x7FCD,
  0x7FD8, 0x7FE1, 0x7FE9, 0x7FF0, 0x7FF5, 0x7FF9, 0x7FFD, 0x7FFE
};

u32 Hash(void *data, u32 size)
{
  u32 hash = 5381;
  u32 i;
  u8 *bytes = (u8*)data;
  for (i = 0; i < size; i++) {
    hash = ((hash << 5) + hash) + bytes[i];
  }
  return hash;
}

static volatile u32 randSeed = 1;

void SeedRandom(u32 seed)
{
  randSeed = seed;
  Random();
}

u32 Random(void)
{
  u32 hiSeed = randSeed >> 16;
  u32 loSeed = randSeed & 0xFFFF;
  u32 a, c;

  a = 0x41A7 * loSeed;
  c = 0x41A7 * hiSeed + (a >> 16);
  c = ((c & 0x7FFF) << 16) + ((2*c) >> 16);
  a = ((a & 0xFFFF) - 0x7FFFFFFF) + c;

  if ((i32)a < 0) a += 0x7FFFFFFF;
  randSeed = a;
  return randSeed;
}

u32 RandomBetween(u32 low, u32 high)
{
  if (high < low) return RandomBetween(high, low);
  u32 range = high - low;
  if (range == 0) return low;

  // Find smallest power of 2 >= range
  u32 mask = range - 1;
  mask |= mask >> 1;
  mask |= mask >> 2;
  mask |= mask >> 4;
  mask |= mask >> 8;
  mask |= mask >> 16;

  u32 r;
  do {
    r = Random() & mask;
  } while (r >= range);

  return r + low;
}

i32 Sin(i16 angle)
{
  angle = ((angle % 360) + 360) % 360;

  i16 i;
  if (angle <= 90) {
    i = (angle * 256) / 90;
    if (i > 255) i = 255;
    return sinTable[i];
  } else if (angle <= 180) {
    i = ((180 - angle) * 256) / 90;
    if (i > 255) i = 255;
    return sinTable[i];
  } else if (angle <= 270) {
    i = ((angle - 180) * 256) / 90;
    if (i > 255) i = 255;
    return -(i32)sinTable[i];
  } else {
    i = ((360 - angle) * 256) / 90;
    if (i > 255) i = 255;
    return -(i32)sinTable[i];
  }
}
